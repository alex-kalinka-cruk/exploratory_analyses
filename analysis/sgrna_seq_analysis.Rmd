---
title: 'CRISPR sgRNA Library composition: Yusa v3 (Knockout)'
author: "Alex Kalinka"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    depth: 3
    highlight: tango
    number_sections: true
    theme: spacelab
    toc: true
    toc_float: true
---


```{r,echo=F}
options(warn=-1)

suppressMessages(library(knitr))
suppressMessages(library(tidyr))
suppressMessages(library(magrittr))
suppressMessages(library(readr))
suppressMessages(library(ggplot2))
suppressMessages(library(dplyr))
suppressMessages(library(GenomicRanges))
suppressMessages(library(anottatr))

select <- dplyr::select
filter <- dplyr::filter

base_path.data <- file.path("~","data","az_cruk")
base_path.ht29 <- file.path(base_path.data,"ht29")

# 'cleanr.tsv' file from Miika.
yusa.v3 <- suppressMessages(suppressWarnings(read_table2(file.path(base_path.data,"cleanr.tsv")))) %>%
  rowwise() %>%
  mutate(GC_percent = 100*(sum(unlist(strsplit(seq,"")) == "G") + sum(unlist(strsplit(seq,"")) == "C"))/20) %>%
  ungroup()

```

# Annotations

```{r,eval=F}
# Annotations of interest.
anns <- c("hg38_genes_promoters","hg38_genes_cds",
          "hg38_genes_introns","hg38_genes_exons",
          "hg38_genes_5UTRs","hg38_genes_3UTRs")
annotations <- build_annotations(genome = "hg38", annotations = anns)

# Process sgRNA coordinates into GRanges object.
yusa.granges <- yusa.v3 %>%
  select(CHRM,STARTpos,ENDpos,STRAND,CODE,GENES,seq) %>%
  mutate(CHRM = paste("chr",CHRM,sep="")) %>%
  makeGRangesFromDataFrame(keep.extra.columns = T,
                           seqnames.field = "CHRM",
                           start.field = "STARTpos",
                           end.field = "ENDpos",
                           strand.field = "STRAND")

# Annotate sgRNAs.
yusa.annot <- data.frame(annotate_regions(regions = yusa.granges, annotations = annotations, 
                               ignore.strand = F, quiet = F))

```

# GC content vs counts

```{r}
plasmid.1 <- read.table(file.path(base_path.ht29,"crisprn","plasmid_test","counts","Plasmid_AZ_1.s_1.counts"),
                        stringsAsFactors = F) %>%
  left_join(yusa.v3, by = c("V1" = "CODE")) %>%
  group_by(GC_percent) %>%
  mutate(median_count = as.integer(round(median(V3,na.rm=T)))) %>%
  ungroup()

ggplot(plasmid.1, aes(GC_percent, V3)) +
  geom_count(aes(color = ..n..)) +
  stat_summary(aes(y = V3), fun.y = median, color = "red", geom="point") +
  geom_smooth() +
  ylim(0,2000) +
  ylab("sgRNA count") +
  ggtitle("HT29: Plasmid Count rep 1 vs GC %")

```



